@{
    ViewData["Title"] = "Dashboard";
    Layout = "_AdminLayout";
}

<link rel="stylesheet" href="~/css/views/admin/dashboard.css" asp-append-version="true" />


<div class="dashboard-container">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active" aria-current="page">
                <i class="bi bi-house-door me-1"></i>Dashboard
            </li>
        </ol>
    </nav>
    <div class="dashboard-section">

        <div class="row g-4">

            @await Html.PartialAsync("_AlertasSistema")

            <div class="col-12 col-sm-6 col-xl-3">
                <div class="stat-card sales">
                    <div class="stat-icon">
                        <i class="bi bi-trophy"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Top Vendedor</h3>
                        <div class="stat-value">Carlos Mora</div>
                        <div class="stat-comparison">
                            <span>‚Ç°850,000 este mes</span>
                        </div>

                    </div>

                </div>

            </div>


            @* <div class="alert alert-info mb-3">
                <h5>üîç Debug Info del Usuario:</h5>
                <p><strong>Autenticado:</strong> @User.Identity.IsAuthenticated</p>
                <p><strong>Nombre:</strong> @(User.Identity.Name ?? "Sin nombre")</p>
                <p><strong>Roles:</strong> @string.Join(", ", User.Claims.Where(c => c.Type == System.Security.Claims.ClaimTypes.Role).Select(c => c.Value))</p>
                <p><strong>Claims totales:</strong> @User.Claims.Count()</p>
            </div>

            <div asp-solo-admin="true">
                <div class="alert alert-danger">
                    <p>üîí Solo los administradores ven esto</p>
                </div>
            </div> *@


            <div class="col-12 col-sm-6 col-xl-3">
                <div class="stat-card inventory">
                    <div class="stat-icon">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Inventario Total</h3>
                        <div class="stat-value">‚Ç°12,500,000</div>
                        <div class="stat-comparison">
                            <span>248 productos</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="stat-card alerts" id="alertas-stock-card">
                    <div class="stat-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Alertas Stock</h3>
                        <div class="stat-value" id="alertas-stock-valor">
                            <i class="spinner-border spinner-border-sm" role="status"></i>
                        </div>
                        <div class="stat-comparison text-warning" id="alertas-stock-detalle">
                            <span>Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="stat-card pending">
                    <div class="stat-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Usuarios Activos</h3>
                        <div class="stat-value">4</div>
                        <div class="stat-comparison">
                            <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#usersPanel">
                                Ver conectados <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Segunda Fila *@
    <div class="dashboard-section">
        <div class="row g-4">
            @* Notas y Recordatorios *@
            <div class="col-12 col-lg-6">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="bi bi-sticky text-warning"></i> Notas R√°pidas</h2>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newNoteModal">
                            <i class="bi bi-plus-lg"></i> Nueva Nota
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="notes-container">
                            <div class="note-item">
                                <div class="note-content">
                                    <h5>Pedido de Llantas</h5>
                                    <p>Llamar al proveedor para confirmar llegada de llantas 205/55R16</p>
                                </div>
                                <div class="note-footer">
                                    <span class="note-date">Hoy, 10:30 AM</span>
                                    <div class="note-actions">
                                        <button class="btn btn-sm btn-link text-success">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        <button class="btn btn-sm btn-link text-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="note-item">
                                <div class="note-content">
                                    <h5>Mantenimiento</h5>
                                    <p>Programar mantenimiento de elevador hidr√°ulico</p>
                                </div>
                                <div class="note-footer">
                                    <span class="note-date">Ayer, 15:45 PM</span>
                                    <div class="note-actions">
                                        <button class="btn btn-sm btn-link text-success">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        <button class="btn btn-sm btn-link text-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @* Anuncios Internos *@
            <div class="col-12 col-lg-6">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="bi bi-megaphone text-primary"></i> Anuncios Internos</h2>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newAnnouncementModal">
                            <i class="bi bi-plus-lg"></i> Nuevo Anuncio
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="announcements-container">
                            <div class="announcement-item important">
                                <div class="announcement-header">
                                    <span class="badge bg-danger">Importante</span>
                                    <span class="announcement-date">15 Feb, 2024</span>
                                </div>
                                <h5>Actualizaci√≥n de Precios</h5>
                                <p>Se han actualizado los precios de todas las llantas. Por favor revisar el nuevo cat√°logo en el sistema.</p>
                            </div>
                            <div class="announcement-item">
                                <div class="announcement-header">
                                    <span class="badge bg-info">Informaci√≥n</span>
                                    <span class="announcement-date">14 Feb, 2024</span>
                                </div>
                                <h5>Capacitaci√≥n Pr√≥xima</h5>
                                <p>Recordatorio: Este viernes tendremos capacitaci√≥n sobre el nuevo sistema de balanceo.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Accesos R√°pidos *@
    <div class="dashboard-section">
        <div class="quick-access-grid">
            <a asp-permiso="Ver Facturaci√≥n" href="@Url.Action("Index", "Facturacion")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-cart-plus"></i>
                </div>
                <span>Nueva Venta</span>
            </a>
            <a asp-permiso="Ver Productos" href="@Url.Action("Index", "Inventario")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-box-seam"></i>
                </div>
                <span>Inventario</span>
            </a>
            <a asp-permiso="Entregar Pendientes" href="@Url.Action("EntregasPendientes", "Facturacion")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-truck"></i>
                </div>
                <span>Entregas Pendientes</span>
            </a>
            <a asp-permiso="Ver Clientes" href="@Url.Action("Index", "Clientes")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-people"></i>
                </div>
                <span>Clientes</span>
            </a>
            <a asp-permiso="Ver Reportes" href="#" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-graph-up"></i>
                </div>
                <span>Reportes</span>
            </a>
            <a asp-permiso="Configuracion Sistema" href="@Url.Action("RolesPermisos", "Configuracion")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-gear"></i>
                </div>
                <span>Configuraci√≥n</span>
            </a>
        </div>
    </div>
</div>

@* Panel de Usuarios Conectados *@
<div class="offcanvas offcanvas-end" id="usersPanel" tabindex="-1">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">
            <i class="bi bi-circle-fill text-success me-2"></i>
            Usuarios Conectados
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="connected-users-list">
            <div class="user-item">
                <div class="user-avatar">CM</div>
                <div class="user-info">
                    <div class="user-name">Carlos Mora</div>
                    <div class="user-role">Vendedor</div>
                    <div class="user-status">Activo hace 5 min</div>
                </div>
            </div>
            <div class="user-item">
                <div class="user-avatar">MR</div>
                <div class="user-info">
                    <div class="user-name">Mar√≠a Rodr√≠guez</div>
                    <div class="user-role">Admin</div>
                    <div class="user-status">Activo hace 2 min</div>
                </div>
            </div>
            <div class="user-item">
                <div class="user-avatar">JG</div>
                <div class="user-info">
                    <div class="user-name">Juan Gonz√°lez</div>
                    <div class="user-role">T√©cnico</div>
                    <div class="user-status">Activo hace 10 min</div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Modal Nueva Nota *@
<div class="modal fade" id="newNoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Nota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newNoteForm">
                    <div class="mb-3">
                        <label class="form-label">T√≠tulo</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contenido</label>
                        <textarea class="form-control" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="newNoteForm" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>
</div>

@* Modal Nuevo Anuncio *@
<div class="modal fade" id="newAnnouncementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuevo Anuncio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newAnnouncementForm">
                    <div class="mb-3">
                        <label class="form-label">T√≠tulo</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contenido</label>
                        <textarea class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Importancia</label>
                        <select class="form-select">
                            <option value="info">Informativo</option>
                            <option value="warning">Importante</option>
                            <option value="danger">Urgente</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha de Vencimiento</label>
                        <input type="date" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="newAnnouncementForm" class="btn btn-primary">Publicar</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    console.log('üìä Dashboard - Inicializando carga de alertas de stock');
    
    // Cargar alertas de stock al cargar la p√°gina
    cargarAlertasStock();
});

/**
 * Funci√≥n para cargar las alertas de stock desde el servidor
 */
async function cargarAlertasStock() {
    try {
        console.log('üìä Cargando alertas de stock...');
        
        const response = await fetch('/Dashboard/ObtenerAlertasStock', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }

        const resultado = await response.json();
        console.log('üìä Respuesta recibida:', resultado);

        if (resultado.success) {
            actualizarVistaAlertasStock(resultado.data);
        } else {
            console.error('‚ùå Error en respuesta:', resultado.message);
            mostrarErrorAlertasStock();
        }

    } catch (error) {
        console.error('‚ùå Error al cargar alertas de stock:', error);
        mostrarErrorAlertasStock();
    }
}

/**
 * Actualizar la vista con los datos de alertas de stock
 */
function actualizarVistaAlertasStock(data) {
    console.log('üìä Actualizando vista con datos:', data);
    
    const $valor = $('#alertas-stock-valor');
    const $detalle = $('#alertas-stock-detalle');
    const $card = $('#alertas-stock-card');
    
    // Actualizar el valor principal
    $valor.text(data.totalAlertas || 0);
    
    // Actualizar el detalle y estilos seg√∫n la cantidad
    if (data.totalAlertas > 0) {
        let mensaje = 'Productos requieren atenci√≥n';
        let claseDetalle = 'text-warning';
        
        if (data.productosAgotados > 0) {
            mensaje = `${data.productosAgotados} agotados, ${data.productosCriticos} cr√≠ticos`;
            claseDetalle = 'text-danger';
        } else if (data.productosCriticos > 0) {
            mensaje = `${data.productosCriticos} productos por agotarse`;
            claseDetalle = 'text-warning';
        }
        
        $detalle.html(`<span>${mensaje}</span>`).attr('class', `stat-comparison ${claseDetalle}`);
        
        // Agregar clase de alerta a la card
        $card.addClass('alert-danger-border');
        
    } else {
        $detalle.html('<span>Stock en buen estado</span>').attr('class', 'stat-comparison text-success');
        $card.removeClass('alert-danger-border');
    }
    
    console.log('‚úÖ Vista de alertas de stock actualizada correctamente');
}

/**
 * Mostrar error en la carga de alertas
 */
function mostrarErrorAlertasStock() {
    const $valor = $('#alertas-stock-valor');
    const $detalle = $('#alertas-stock-detalle');
    
    $valor.text('--');
    $detalle.html('<span class="text-muted">Error al cargar</span>').attr('class', 'stat-comparison text-muted');
    
    console.log('‚ùå Error mostrado en vista de alertas');
}
</script>