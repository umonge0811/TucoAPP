@model Tuco.Clases.DTOs.Inventario.InventarioProgramadoDTO
@{
    ViewData["Title"] = "Toma de Inventario - " + Model.Titulo;
    Layout = "_AdminLayout";
}

<!-- CSS específico para toma de inventario -->
<link rel="stylesheet" href="~/css/views/inventario/tomainventario.css">
@* <link rel="stylesheet" href="~/css/views/toma-inventario/mobile.css">
 *@
<div class="container-fluid toma-inventario-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action("Index", "Dashboard")" class="text-decoration-none">
                    <i class="bi bi-house-door me-1"></i>Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="@Url.Action("ProgramarInventario", "Inventario")" class="text-decoration-none">
                    <i class="bi bi-calendar-check me-1"></i>Inventarios
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="bi bi-tablet me-1"></i>Toma de Inventario
            </li>
        </ol>
    </nav>

    <!-- Header de la toma -->
    <div class="toma-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-6 mb-2">
                    <i class="bi bi-tablet text-primary me-2"></i>
                    @Model.Titulo
                </h1>
                <p class="text-muted mb-0">
                    <i class="bi bi-calendar3 me-1"></i>
                    Inventario programado desde @Model.FechaInicio.ToString("dd/MM/yyyy")
                    hasta @Model.FechaFin.ToString("dd/MM/yyyy")
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="estado-inventario">
                    <span class="badge bg-success fs-6 px-3 py-2">
                        <i class="bi bi-play-circle me-1"></i>
                        @Model.Estado
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de progreso -->
    <div class="progress-panel mb-4">
        <div class="dashboard-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Progreso del Inventario
                    </h3>
                    <button class="btn btn-outline-primary btn-sm" id="btnActualizarProgreso">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Actualizar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <!-- Barra de progreso principal -->
                    <div class="col-12">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold">Progreso General</span>
                            <span class="text-primary fw-bold" id="porcentajeProgreso">0%</span>
                        </div>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 0%;"
                                 id="barraProgreso">
                            </div>
                        </div>
                    </div>

                    <!-- Estadísticas detalladas -->
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-primary">
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalProductos">-</div>
                                <div class="stat-label">Total Productos</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-success">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="productosContados">-</div>
                                <div class="stat-label">Contados</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-warning">
                                <i class="bi bi-clock"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="productosPendientes">-</div>
                                <div class="stat-label">Pendientes</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-danger">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number" id="discrepancias">-</div>
                                <div class="stat-label">Discrepancias</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de ajustes pendientes -->
    <div class="ajustes-pendientes-panel mb-4" id="ajustesPendientesPanel" style="display: none;">
        <div class="dashboard-card">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Ajustes Pendientes
                        <span class="badge bg-danger ms-2" id="contadorAjustesPendientes">0</span>
                    </h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-dark btn-sm" id="btnActualizarAjustes">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Actualizar
                        </button>
                        <button class="btn btn-outline-dark btn-sm" id="btnToggleAjustes">
                            <i class="bi bi-chevron-up me-1"></i>
                            Ocultar
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body" id="contenidoAjustesPendientes">
                <!-- Resumen estadístico -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card-mini">
                            <div class="stat-icon-mini bg-info">
                                <i class="bi bi-arrow-up-circle"></i>
                            </div>
                            <div class="stat-content-mini">
                                <div class="stat-number-mini" id="totalEntradas">0</div>
                                <div class="stat-label-mini">Entradas</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-mini">
                            <div class="stat-icon-mini bg-warning">
                                <i class="bi bi-arrow-down-circle"></i>
                            </div>
                            <div class="stat-content-mini">
                                <div class="stat-number-mini" id="totalSalidas">0</div>
                                <div class="stat-label-mini">Salidas</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-mini">
                            <div class="stat-icon-mini bg-secondary">
                                <i class="bi bi-gear"></i>
                            </div>
                            <div class="stat-content-mini">
                                <div class="stat-number-mini" id="totalAjustes">0</div>
                                <div class="stat-label-mini">Ajustes</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card-mini">
                            <div class="stat-icon-mini bg-success">
                                <i class="bi bi-check2-circle"></i>
                            </div>
                            <div class="stat-content-mini">
                                <div class="stat-number-mini" id="totalCorrecciones">0</div>
                                <div class="stat-label-mini">Correcciones</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de ajustes pendientes -->
                <div class="ajustes-lista">
                    <h5 class="mb-3">
                        <i class="bi bi-list-check me-2"></i>
                        Detalle de Ajustes Pendientes
                    </h5>

                    <!-- Estado vacío -->
                    <div class="text-center py-4" id="ajustesVacio">
                        <i class="bi bi-check-circle display-4 text-success mb-3"></i>
                        <h5 class="text-muted">No hay ajustes pendientes</h5>
                        <p class="text-muted mb-0">
                            Todos los productos han sido contados sin discrepancias o los ajustes ya fueron registrados.
                        </p>
                    </div>

                    <!-- Tabla de ajustes -->
                    <div class="table-responsive" id="tablaAjustes" style="display: none;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Producto</th>
                                    <th width="10%">Sistema</th>
                                    <th width="10%">Físico</th>
                                    <th width="10%">Diferencia</th>
                                    <th width="15%">Tipo Ajuste</th>
                                    <th width="25%">Motivo</th>
                                    <th width="10%">Final</th>
                                    <th width="5%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaAjustesBody">
                                <!-- Los ajustes se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de finalización del inventario - AGREGAR DESPUÉS DEL PANEL DE PRODUCTOS -->
    <div class="finalizacion-panel mt-4" id="finalizacionPanel" style="display: none;">
        <div class="dashboard-card border-success">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        Finalizar Inventario
                    </h3>
                    <span class="badge bg-light text-success" id="estadoFinalizacion">
                        <i class="bi bi-hourglass-split me-1"></i>
                        Listo para finalizar
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Resumen final -->
                <div class="row g-4 mb-4">
                    <div class="col-md-8">
                        <h5 class="text-success mb-3">
                            <i class="bi bi-clipboard-check me-2"></i>
                            Resumen de la Toma de Inventario
                        </h5>
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <div class="d-flex justify-content-between">
                                    <span>📦 Total de productos:</span>
                                    <strong id="resumenTotalProductos">-</strong>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex justify-content-between">
                                    <span>✅ Productos contados:</span>
                                    <strong class="text-success" id="resumenProductosContados">-</strong>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex justify-content-between">
                                    <span>⚠️ Con discrepancias:</span>
                                    <strong class="text-warning" id="resumenDiscrepancias">-</strong>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex justify-content-between">
                                    <span>🔄 Ajustes pendientes:</span>
                                    <strong class="text-primary" id="resumenAjustesPendientes">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="progress-circle-container">
                            <div class="progress-circle">
                                <span id="porcentajeCompletoFinal">0%</span>
                            </div>
                            <p class="text-muted mt-2">Progreso Completado</p>
                        </div>
                    </div>
                </div>

                <!-- Alertas y validaciones -->
                <div class="alertas-finalizacion mb-4">
                    <!-- Alerta de productos pendientes -->
                    <div class="alert alert-warning" id="alertaProductosPendientes" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <div>
                                <strong>Atención:</strong> Aún hay <span id="cantidadPendientes">0</span> productos sin contar.
                                <br><small>Debes contar todos los productos antes de finalizar el inventario.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de ajustes pendientes -->
                    <div class="alert alert-info" id="alertaAjustesPendientes" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle me-2"></i>
                            <div>
                                <strong>Información:</strong> Se aplicarán <span id="cantidadAjustes">0</span> ajustes al stock del sistema.
                                <br><small>Esta acción es irreversible. Revisa los ajustes antes de continuar.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de éxito -->
                    <div class="alert alert-success" id="alertaListoParaFinalizar" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle me-2"></i>
                            <div>
                                <strong>¡Perfecto!</strong> Todos los productos han sido contados.
                                <br><small>El inventario está listo para ser finalizado.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de permisos -->
                    <div class="alert alert-warning" id="alertaSinPermisos" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shield-exclamation me-2"></i>
                            <div>
                                <strong>Sin permisos:</strong> Solo usuarios con permisos de validación pueden finalizar inventarios.
                                <br><small>Contacta a un supervisor para finalizar este inventario.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones de finalización -->
                <div class="acciones-finalizacion">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100" id="btnVerResumenCompleto">
                                <i class="bi bi-file-text me-2"></i>
                                Ver Resumen Completo
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-warning w-100" id="btnExportarInventario">
                                <i class="bi bi-download me-2"></i>
                                Exportar Inventario
                            </button>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-success btn-lg w-100" id="btnFinalizarInventario" disabled>
                                <span class="normal-state">
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                    Finalizar Inventario y Aplicar Ajustes
                                </span>
                                <span class="loading-state" style="display: none;">
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    Finalizando inventario...
                                </span>
                            </button>
                            <small class="text-muted d-block text-center mt-2">
                                <i class="bi bi-shield-check me-1"></i>
                                Esta acción aplicará todos los ajustes pendientes al stock del sistema
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de búsqueda y filtros -->
    <div class="search-panel mb-4">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="bi bi-search me-2"></i>
                    Buscar y Filtrar Productos
                </h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Búsqueda rápida -->
                    <div class="col-md-6">
                        <label for="busquedaRapida" class="form-label">
                            <i class="bi bi-search me-1"></i>
                            Búsqueda Rápida
                        </label>
                        <div class="input-group">
                            <input type="text"
                                   class="form-control"
                                   id="busquedaRapida"
                                   placeholder="ID, nombre, marca, modelo...">
                            <button class="btn btn-primary" type="button" id="btnBuscar">
                                <i class="bi bi-search"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="btnLimpiarBusqueda">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Filtro por estado -->
                    <div class="col-md-3">
                        <label for="filtroEstado" class="form-label">
                            <i class="bi bi-funnel me-1"></i>
                            Estado
                        </label>
                        <select class="form-select" id="filtroEstado">
                            <option value="">Todos</option>
                            <option value="pendiente">⏳ Pendientes</option>
                            <option value="contado">✅ Contados</option>
                            <option value="discrepancia">⚠️ Con Discrepancia</option>
                        </select>
                    </div>

                    <!-- Filtro por tipo -->
                    <div class="col-md-3">
                        <label for="filtroTipo" class="form-label">
                            <i class="bi bi-tags me-1"></i>
                            Tipo
                        </label>
                        <select class="form-select" id="filtroTipo">
                            <option value="">Todos</option>
                            <option value="llanta">🛞 Llantas</option>
                            <option value="accesorio">🔧 Accesorios</option>
                        </select>
                    </div>
                </div>

                <!-- Botones de acción rápida -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-outline-primary btn-sm" id="btnMostrarTodos">
                                <i class="bi bi-list-ul me-1"></i>
                                Mostrar Todos
                            </button>
                            <button class="btn btn-outline-warning btn-sm" id="btnSoloPendientes">
                                <i class="bi bi-clock me-1"></i>
                                Solo Pendientes
                            </button>
                            <button class="btn btn-outline-danger btn-sm" id="btnSoloDiscrepancias">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Solo Discrepancias
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de productos -->
    <div class="productos-panel">
        <div class="dashboard-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>
                        Productos para Contar
                        <span class="badge bg-primary ms-2" id="contadorProductosMostrados">0</span>
                    </h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" id="btnVistaTarjetas">
                            <i class="bi bi-grid me-1"></i>
                            Tarjetas
                        </button>
                        <button class="btn btn-primary btn-sm" id="btnVistaLista">
                            <i class="bi bi-list me-1"></i>
                            Lista
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading state -->
                <div class="text-center py-5" id="loadingProductos">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Cargando productos...</span>
                    </div>
                    <p class="text-muted">Cargando productos del inventario...</p>
                </div>

                <!-- Vista de lista (por defecto) -->
                <div class="productos-lista" id="productosLista" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%" class="text-center">#</th>
                                    <th width="8%" class="text-center">Imagen</th>
                                    <th width="25%">Producto</th>
                                    <th width="8%" class="text-center">Sistema</th>
                                    <th width="8%" class="text-center">Físico</th>
                                    <th width="8%" class="text-center">Diferencia</th>
                                    <th width="15%" class="text-center">Estado</th>
                                    <th width="20%" class="text-center">Acciones</th>
                                    <th width="3%" class="text-center">
                                        <i class="bi bi-gear" data-bs-toggle="tooltip" title="Ajustes pendientes"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tablaProductosBody">
                                <!-- Los productos se cargarán aquí dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Vista de tarjetas (móvil) -->
                <div class="productos-tarjetas" id="productosTarjetas" style="display: none;">
                    <div class="row g-3" id="contenedorTarjetas">
                        <!-- Las tarjetas se cargarán aquí dinámicamente -->
                    </div>
                </div>

                <!-- Estado vacío -->
                <div class="text-center py-5" id="estadoVacio" style="display: none;">
                    <i class="bi bi-inbox display-1 text-muted mb-3"></i>
                    <h4 class="text-muted mb-2">No hay productos para mostrar</h4>
                    <p class="text-muted">
                        No se encontraron productos que coincidan con los filtros aplicados.
                    </p>
                    <button class="btn btn-outline-primary" id="btnLimpiarFiltros">
                        <i class="bi bi-funnel me-1"></i>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de finalización del inventario -->
    <div class="finalizacion-panel mt-4" id="finalizacionPanel" style="display: none;">
        <div class="dashboard-card border-success">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        Finalizar Inventario
                    </h3>
                    <span class="badge bg-light text-success" id="estadoFinalizacion">
                        <i class="bi bi-hourglass-split me-1"></i>
                        Listo para finalizar
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Resumen final -->
                <div class="row g-4 mb-4">
                    <div class="col-md-8">
                        <h5 class="text-success mb-3">
                            <i class="bi bi-clipboard-check me-2"></i>
                            Resumen de la Toma de Inventario
                        </h5>
                        <div class="row g-3">
                            <div class="col-sm-6">
                                <div class="d-flex justify-content-between">
                                    <span>📦 Total de productos:</span>
                                    <strong id="resumenTotalProductos">-</strong>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex justify-content-between">
                                    <span>✅ Productos contados:</span>
                                    <strong class="text-success" id="resumenProductosContados">-</strong>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex justify-content-between">
                                    <span>⚠️ Con discrepancias:</span>
                                    <strong class="text-warning" id="resumenDiscrepancias">-</strong>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="d-flex justify-content-between">
                                    <span>🔄 Ajustes pendientes:</span>
                                    <strong class="text-primary" id="resumenAjustesPendientes">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="progress-circle-container">
                            <div class="progress-circle">
                                <span id="porcentajeCompletoFinal">0%</span>
                            </div>
                            <p class="text-muted mt-2">Progreso Completado</p>
                        </div>
                    </div>
                </div>

                <!-- Alertas y validaciones -->
                <div class="alertas-finalizacion mb-4">
                    <!-- Alerta de productos pendientes -->
                    <div class="alert alert-warning" id="alertaProductosPendientes" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <div>
                                <strong>Atención:</strong> Aún hay <span id="cantidadPendientes">0</span> productos sin contar.
                                <br><small>Debes contar todos los productos antes de finalizar el inventario.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de ajustes pendientes -->
                    <div class="alert alert-info" id="alertaAjustesPendientes" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle me-2"></i>
                            <div>
                                <strong>Información:</strong> Se aplicarán <span id="cantidadAjustes">0</span> ajustes al stock del sistema.
                                <br><small>Esta acción es irreversible. Revisa los ajustes antes de continuar.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de éxito -->
                    <div class="alert alert-success" id="alertaListoParaFinalizar" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle me-2"></i>
                            <div>
                                <strong>¡Perfecto!</strong> Todos los productos han sido contados.
                                <br><small>El inventario está listo para ser finalizado.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones de finalización -->
                <div class="acciones-finalizacion">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100" id="btnVerResumenCompleto">
                                <i class="bi bi-file-text me-2"></i>
                                Ver Resumen Completo
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-warning w-100" id="btnExportarInventario">
                                <i class="bi bi-download me-2"></i>
                                Exportar Inventario
                            </button>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-success btn-lg w-100" id="btnFinalizarInventario" disabled>
                                <span class="normal-state">
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                    Finalizar Inventario y Aplicar Ajustes
                                </span>
                                <span class="loading-state" style="display: none;">
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    Finalizando inventario...
                                </span>
                            </button>
                            <small class="text-muted d-block text-center mt-2">
                                <i class="bi bi-shield-check me-1"></i>
                                Esta acción aplicará todos los ajustes pendientes al stock del sistema
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear ajuste pendiente -->
<div class="modal fade" id="ajustePendienteModal" tabindex="-1" aria-labelledby="ajustePendienteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="ajustePendienteModalLabel">
                    <i class="bi bi-clock-history me-2"></i>
                    Registrar Ajuste Pendiente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ajustePendienteForm">
                    <!-- Campo oculto para el ID del producto -->
                    <input type="hidden" id="productoIdAjustePendiente" value="">
                    <input type="hidden" id="inventarioIdAjustePendiente" value="@Model.InventarioProgramadoId">

                    <!-- Información del producto y discrepancia -->
                    <div class="alert alert-warning mb-3" id="infoDiscrepanciaPendiente">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
                            <div>
                                <strong>Producto:</strong> <span id="nombreProductoAjustePendiente">-</span><br>
                                <strong>Stock en Sistema:</strong> <span id="stockSistemaAjustePendiente">-</span> unidades<br>
                                <strong>Cantidad Física Contada:</strong> <span id="stockFisicoAjustePendiente">-</span> unidades<br>
                                <strong>Discrepancia:</strong>
                                <span id="discrepanciaAjustePendiente" class="fw-bold">-</span> unidades
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Tipo de ajuste -->
                        <div class="col-md-6 mb-3">
                            <label for="tipoAjustePendiente" class="form-label fw-bold">
                                <i class="bi bi-gear me-1"></i>
                                Tipo de Ajuste <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="tipoAjustePendiente" required>
                                <option value="">Seleccione el tipo</option>
                                <option value="sistema_a_fisico">📦 Ajustar Sistema al Físico</option>
                                <option value="reconteo">🔄 Solicitar Reconteo</option>
                                <option value="validado">✅ Marcar como Validado</option>
                            </select>                            <div class="form-text">
                                <small>
                                    <strong>Entrada:</strong> Aumentar stock<br>
                                    <strong>Salida:</strong> Reducir stock<br>
                                    <strong>Ajuste Sistema:</strong> Corregir error del sistema<br>
                                    <strong>Corrección:</strong> Error en el conteo físico
                                </small>
                            </div>
                        </div>

                        <!-- Cantidad final propuesta -->
                        <div class="col-md-6 mb-3">
                            <label for="cantidadFinalPropuesta" class="form-label fw-bold">
                                <i class="bi bi-123 me-1"></i>
                                Cantidad Final Propuesta
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-hash"></i>
                                </span>
                                <input type="number"
                                       class="form-control"
                                       id="cantidadFinalPropuesta"
                                       min="0"
                                       max="99999"
                                       readonly>
                                <span class="input-group-text">unidades</span>
                            </div>
                            <div class="form-text">
                                <small>Se calculará automáticamente basado en el conteo físico</small>
                            </div>
                        </div>
                    </div>

                    <!-- Motivo del ajuste -->
                    <div class="mb-3">
                        <label for="motivoAjustePendiente" class="form-label fw-bold">
                            <i class="bi bi-chat-text me-1"></i>
                            Motivo del Ajuste <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control"
                                  id="motivoAjustePendiente"
                                  rows="3"
                                  maxlength="500"
                                  required
                                  placeholder="Explique el motivo de la discrepancia y la justificación del ajuste..."></textarea>
                        <div class="form-text">
                            <small>Este motivo será revisado al finalizar el inventario. Máximo 500 caracteres.</small>
                        </div>
                    </div>

                    <!-- Vista previa del ajuste pendiente -->
                    <div class="card border-info mb-3" id="vistaPreviaAjustePendiente">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-eye me-2"></i>
                                Vista Previa del Ajuste Pendiente
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="border-end">
                                        <div class="h6 mb-1" id="stockActualPreview">-</div>
                                        <small class="text-muted">Stock Actual</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="border-end">
                                        <div class="h6 mb-1 text-info" id="conteoFisicoPreview">-</div>
                                        <small class="text-muted">Conteo Físico</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="border-end">
                                        <div class="h6 mb-1 text-warning" id="tipoAjustePreview">-</div>
                                        <small class="text-muted">Tipo Ajuste</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="h6 mb-1 text-success" id="stockFinalPreview">-</div>
                                    <small class="text-muted">Stock Propuesto</small>
                                </div>
                            </div>
                            <div class="mt-2 text-center">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Este ajuste se aplicará al finalizar el inventario
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="guardarAjustePendienteBtn">
                    <span class="normal-state">
                        <i class="bi bi-clock-history me-2"></i>Registrar Ajuste Pendiente
                    </span>
                    <span class="loading-state" style="display: none;">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Registrando...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal para registrar conteo -->
<div class="modal fade" id="conteoModal" tabindex="-1" aria-labelledby="conteoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="conteoModalLabel">
                    <i class="bi bi-123 me-2"></i>
                    Registrar Conteo Físico
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Información del producto -->
                <div class="producto-info mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="producto-imagen">
                                <img id="imagenProductoConteo"
                                     src=""
                                     alt="Producto"
                                     class="img-fluid rounded"
                                     style="max-height: 120px; object-fit: cover;">
                            </div>
                        </div>
                        <div class="col-md-9">
                            <h4 id="nombreProductoConteo" class="mb-2">Producto</h4>
                            <p class="text-muted mb-1" id="descripcionProductoConteo">Descripción</p>
                            <div class="badges mb-2">
                                <span class="badge bg-secondary" id="idProductoConteo">ID: -</span>
                                <span class="badge bg-info" id="tipoProductoConteo">Tipo</span>
                            </div>
                            <div class="medidas-llanta" id="medidasLlantaConteo" style="display: none;">
                                <small class="text-muted">
                                    <i class="bi bi-car-front me-1"></i>
                                    <span id="especificacionesLlanta">-</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario de conteo -->
                <form id="formConteo">
                    <input type="hidden" id="inventarioIdConteo" value="@Model.InventarioProgramadoId">
                    <input type="hidden" id="productoIdConteo" value="">

                    <div class="row g-3">
                        <!-- Cantidad en sistema -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-pc-display me-1"></i>
                                Cantidad en Sistema
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="bi bi-database"></i>
                                </span>
                                <input type="number"
                                       class="form-control"
                                       id="cantidadSistemaConteo"
                                       readonly>
                                <span class="input-group-text">unidades</span>
                            </div>
                        </div>

                        <!-- Cantidad física -->
                        <div class="col-md-6">
                            <label for="cantidadFisicaConteo" class="form-label fw-bold">
                                <i class="bi bi-person-check me-1"></i>
                                Cantidad Física Contada <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="bi bi-123"></i>
                                </span>
                                <input type="number"
                                       class="form-control form-control-lg"
                                       id="cantidadFisicaConteo"
                                       min="0"
                                       required
                                       placeholder="0">
                                <span class="input-group-text">unidades</span>
                            </div>
                        </div>
                    </div>

                    <!-- Vista previa de diferencia -->
                    <div class="alert mt-3" id="alertaDiferencia" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle me-2"></i>
                            <div>
                                <strong>Diferencia detectada:</strong>
                                <span id="textoDiferencia">0 unidades</span>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-3">
                        <label for="observacionesConteo" class="form-label">
                            <i class="bi bi-chat-text me-1"></i>
                            Observaciones
                        </label>
                        <textarea class="form-control"
                                  id="observacionesConteo"
                                  rows="3"
                                  maxlength="500"
                                  placeholder="Anote cualquier observación sobre el conteo (opcional)..."></textarea>
                        <div class="form-text">Máximo 500 caracteres</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardarConteo">
                    <span class="normal-state">
                        <i class="bi bi-check-lg me-2"></i>
                        Registrar Conteo
                    </span>
                    <span class="loading-state" style="display: none;">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Guardando...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts específicos -->
@section Scripts {
    <script>
        // Variables globales para la toma de inventario
        window.inventarioConfig = {
            inventarioId: @Model.InventarioProgramadoId,
            usuarioId: @ViewBag.UsuarioId,
            permisos: {
                puedeContar: @(ViewBag.PuedeContar.ToString().ToLower()),
                puedeAjustar: @(ViewBag.PuedeAjustar.ToString().ToLower()),
                puedeValidar: @(ViewBag.PuedeValidar.ToString().ToLower()),
                esAdmin: @(ViewBag.EsAdmin.ToString().ToLower())
            }
        };
    </script>
    <script src="~/js/views/Inventario/ejecutar.js"></script>
    <script src="~/js/utils/reportesUtils.js"></script>
}