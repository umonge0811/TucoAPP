@page "/cambiar-contrasena/{token}"
@rendermode InteractiveServer

<h3>Cambiar Contraseña</h3>
@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert alert-info">@mensaje</div>
}

@if (mostrarFormulario)
{
    <div>
        <label for="nuevaContrasena">Nueva Contraseña:</label>
        <input type="password" @bind="nuevaContrasena" class="form-control" placeholder="Ingrese su nueva contraseña" />

        <label for="repetirContrasena" class="mt-2">Repita la Contraseña:</label>
        <input type="password" @bind="repetirContrasena" class="form-control" placeholder="Repita su nueva contraseña" />

        @if (!string.IsNullOrEmpty(errorValidacion))
        {
            <div class="text-danger mt-2">@errorValidacion</div>
        }

        <button @onclick="CambiarContrasenaAsync" aria-label="Cambiar contraseña" class="btn btn-primary mt-2" disabled="@isLoading">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            }
            Cambiar Contraseña
        </button>
    </div>
}

@code {
    [Parameter, Required]
    public string token { get; set; }

    private string nuevaContrasena = string.Empty;
    private string repetirContrasena = string.Empty;
    private string mensaje = string.Empty;
    private string errorValidacion = string.Empty;
    private bool isLoading = false;
    private bool mostrarFormulario = true;

    protected override async Task OnParametersSetAsync()
    {
        if (!TokenState.IsInitialized)
        {
            if (!string.IsNullOrEmpty(TokenState.Token))
            {
                token = TokenState.Token;
                mensaje = "El usuario ya fue activado.";
                return;
            }

            try
            {
                var activationResponse = await Http.GetAsync($"api/Auth/activar-cuenta?token={Uri.EscapeDataString(token)}");
                if (activationResponse.IsSuccessStatusCode)
                {
                    var result = await activationResponse.Content.ReadFromJsonAsync<ActivationResponseDTO>();
                    TokenState.Token = result.Token;
                    mensaje = result.Message;
                }
                else
                {
                    var errorMessage = await activationResponse.Content.ReadAsStringAsync();
                    mensaje = $"Error al activar la cuenta: {errorMessage}";
                }
            }
            catch (Exception ex)
            {
                mensaje = $"Error inesperado: {ex.Message}";
            }

            TokenState.IsInitialized = true;
        }
    }

    private async Task CambiarContrasenaAsync()
    {
        // Validaciones de contraseña
        if (string.IsNullOrEmpty(nuevaContrasena) || string.IsNullOrEmpty(repetirContrasena))
        {
            errorValidacion = "Debe ingresar y repetir la contraseña.";
            return;
        }

        if (nuevaContrasena != repetirContrasena)
        {
            errorValidacion = "Las contraseñas no coinciden.";
            return;
        }

        if (nuevaContrasena.Length < 8)
        {
            errorValidacion = "La contraseña debe tener al menos 8 caracteres.";
            return;
        }

        errorValidacion = string.Empty;
        isLoading = true;

        try
        {
            var response = await Http.PostAsJsonAsync("/api/Usuarios/CambiarContrasena",
                new { token = TokenState.Token, NuevaContrasena = nuevaContrasena });

            if (response.IsSuccessStatusCode)
            {
                mensaje = "Contraseña cambiada exitosamente.";
                TokenState.Token = string.Empty; // Limpiar token
                TokenState.IsInitialized = false;
                mostrarFormulario = false; // Ocultar formulario

                // Mostrar SweetAlert para el éxito
                await JSRuntime.InvokeVoidAsync("Swal.fire", new
                {
                    title = "Éxito",
                    text = "Su contraseña ha sido cambiada correctamente.",
                    icon = "success",
                    confirmButtonText = "OK"
                });
            }
            else
            {
                var errorMessage = await response.Content.ReadAsStringAsync();
                mensaje = $"Error al cambiar la contraseña: {errorMessage}";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
