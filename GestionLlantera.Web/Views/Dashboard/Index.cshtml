@{
    ViewData["Title"] = "Dashboard";
    Layout = "_AdminLayout";
}

<meta name="user-id" content="@ViewBag.CurrentUserId" />

<link rel="stylesheet" href="~/css/views/admin/dashboard.css" asp-append-version="true" />


<div class="dashboard-container">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item active" aria-current="page">
                <i class="bi bi-house-door me-1"></i>Dashboard
            </li>
        </ol>
    </nav>
    <div class="dashboard-section">

        <div class="row g-4">

            @await Html.PartialAsync("_AlertasSistema")

            <div class="col-12 col-sm-6 col-xl-3">
                <div class="stat-card sales" data-section="top-vendedor">
                    <div class="stat-icon">
                        <i class="bi bi-trophy"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Top Vendedor</h3>
                        <div class="stat-value">
                            <i class="spinner-border spinner-border-sm" role="status"></i>
                        </div>
                        <div class="stat-comparison">
                            <span>Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>


            @* <div class="alert alert-info mb-3">
                <h5>🔍 Debug Info del Usuario:</h5>
                <p><strong>Autenticado:</strong> @User.Identity.IsAuthenticated</p>
                <p><strong>Nombre:</strong> @(User.Identity.Name ?? "Sin nombre")</p>
                <p><strong>Roles:</strong> @string.Join(", ", User.Claims.Where(c => c.Type == System.Security.Claims.ClaimTypes.Role).Select(c => c.Value))</p>
                <p><strong>Claims totales:</strong> @User.Claims.Count()</p>
            </div>

            <div asp-solo-admin="true">
                <div class="alert alert-danger">
                    <p>🔒 Solo los administradores ven esto</p>
                </div>
            </div> *@


            <div class="col-12 col-sm-6 col-xl-3">
                <div class="stat-card inventory" id="inventario-total-card">
                    <div class="stat-icon">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Inventario Total</h3>
                        <div class="stat-value" id="inventario-total-valor">
                            <i class="spinner-border spinner-border-sm" role="status"></i>
                        </div>
                        <div class="stat-comparison" id="inventario-total-detalle">
                            <span>Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="stat-card alerts" id="alertas-stock-card">
                    <div class="stat-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Alertas Stock</h3>
                        <div class="stat-value" id="alertas-stock-valor">
                            <i class="spinner-border spinner-border-sm" role="status"></i>
                        </div>
                        <div class="stat-comparison text-warning" id="alertas-stock-detalle">
                            <span>Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="stat-card pending">
                    <div class="stat-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Usuarios Activos</h3>
                        <div class="stat-value">4</div>
                        <div class="stat-comparison">
                            <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#usersPanel">
                                Ver conectados <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Segunda Fila *@
    <div class="dashboard-section">
        <div class="row g-4">
            @* Notas y Recordatorios *@
            <div class="col-12 col-lg-6">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="bi bi-sticky text-warning"></i> Notas Rápidas</h2>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newNoteModal">
                            <i class="bi bi-plus-lg"></i> Nueva Nota
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="notes-container">

                        </div>
                    </div>
                </div>
            </div>

            @* Anuncios Internos *@
            <div class="col-12 col-lg-6">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="bi bi-megaphone text-primary"></i> Anuncios Internos</h2>
                        <button asp-permiso="Crear Anuncios" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newAnnouncementModal">
                            <i class="bi bi-plus-lg"></i> Nuevo Anuncio
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="announcements-container">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Acceso Rápido *@
    <div class="dashboard-section">
        <div class="quick-access-grid">
            <a asp-permiso="Ver Facturación" href="@Url.Action("Index", "Facturacion")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-cart-plus"></i>
                </div>
                <span>Nueva Venta</span>
            </a>
            <a asp-permiso="Ver Productos" href="@Url.Action("Index", "Inventario")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-box-seam"></i>
                </div>
                <span>Inventario</span>
            </a>
            <a asp-permiso="Entregar Pendientes" href="@Url.Action("EntregasPendientes", "Facturacion")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-truck"></i>
                </div>
                <span>Entregas Pendientes</span>
            </a>
            <a asp-permiso="Ver Clientes" href="@Url.Action("Index", "Clientes")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-people"></i>
                </div>
                <span>Clientes</span>
            </a>
            <a asp-permiso="Ver Reportes" href="#" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-graph-up"></i>
                </div>
                <span>Reportes</span>
            </a>
            <a asp-permiso="Configuracion Sistema" href="@Url.Action("RolesPermisos", "Configuracion")" class="quick-access-card">
                <div class="quick-access-icon">
                    <i class="bi bi-gear"></i>
                </div>
                <span>Configuración</span>
            </a>
        </div>
    </div>
</div>

@* Panel de Usuarios Conectados *@
<div class="offcanvas offcanvas-end" id="usersPanel" tabindex="-1">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">
            <i class="bi bi-circle-fill text-success me-2"></i>
            Usuarios Conectados
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="connected-users-list">
            <div class="user-item">
                <div class="user-avatar">CM</div>
                <div class="user-info">
                    <div class="user-name">Carlos Mora</div>
                    <div class="user-role">Vendedor</div>
                    <div class="user-status">Activo hace 5 min</div>
                </div>
            </div>
            <div class="user-item">
                <div class="user-avatar">MR</div>
                <div class="user-info">
                    <div class="user-name">María Rodríguez</div>
                    <div class="user-role">Admin</div>
                    <div class="user-status">Activo hace 2 min</div>
                </div>
            </div>
            <div class="user-item">
                <div class="user-avatar">JG</div>
                <div class="user-info">
                    <div class="user-name">Juan González</div>
                    <div class="user-role">Técnico</div>
                    <div class="user-status">Activo hace 10 min</div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Modal Nueva Nota *@
<div class="modal fade" id="newNoteModal" tabindex="-1" aria-labelledby="newNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newNoteModalLabel">
                    <i class="fas fa-sticky-note text-warning me-2"></i>Nueva Nota Rápida
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="newNoteForm">
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="titulo" class="form-label">Título</label>
                        <input type="text" class="form-control" id="titulo" name="titulo" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="contenido" class="form-label">Contenido</label>
                        <textarea class="form-control" id="contenido" name="contenido" rows="4" required maxlength="1000"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="color" class="form-label">Color</label>
                            <select class="form-select" id="color" name="color">
                                <option value="#ffd700">Amarillo (por defecto)</option>
                                <option value="#87ceeb">Azul claro</option>
                                <option value="#98fb98">Verde claro</option>
                                <option value="#ffa07a">Naranja claro</option>
                                <option value="#dda0dd">Morado claro</option>
                                <option value="#f0e68c">Amarillo pálido</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Nota
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Nuevo Anuncio -->
<div class="modal fade" id="newAnnouncementModal" tabindex="-1" aria-labelledby="newAnnouncementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="newAnnouncementModalLabel">
                    <i class="fas fa-bullhorn me-2"></i>Nuevo Anuncio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="newAnnouncementForm">
                <div class="modal-body">
                    <!-- Título del Anuncio -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="tituloAnuncio" class="form-label required">
                                <i class="fas fa-heading text-primary me-1"></i>Título del Anuncio
                            </label>
                            <input type="text" class="form-control" id="tituloAnuncio" name="titulo" 
                                   required maxlength="200" placeholder="Ingresa el título del anuncio">
                            <div class="form-text">Máximo 200 caracteres</div>
                        </div>
                    </div>

                    <!-- Contenido del Anuncio -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="contenidoAnuncio" class="form-label required">
                                <i class="fas fa-align-left text-primary me-1"></i>Contenido
                            </label>
                            <textarea class="form-control" id="contenidoAnuncio" name="contenido" rows="4" 
                                      required maxlength="2000" placeholder="Describe el contenido del anuncio"></textarea>
                            <div class="form-text">Máximo 2000 caracteres</div>
                        </div>
                    </div>

                    <!-- Tipo de Anuncio y Prioridad -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tipoAnuncio" class="form-label">
                                <i class="fas fa-tags text-primary me-1"></i>Tipo de Anuncio
                            </label>
                            <select class="form-select" id="tipoAnuncio" name="tipoAnuncio">
                                <option value="General">General</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Promocion">Promoción</option>
                                <option value="Urgente">Urgente</option>
                                <option value="Informativo">Informativo</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="prioridadAnuncio" class="form-label">
                                <i class="fas fa-exclamation-triangle text-primary me-1"></i>Prioridad
                            </label>
                            <select class="form-select" id="prioridadAnuncio" name="prioridad">
                                <option value="Baja">Baja</option>
                                <option value="Normal" selected>Normal</option>
                                <option value="Alta">Alta</option>
                                <option value="Critica">Crítica</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fecha de Vencimiento y Configuración -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="fechaVencimientoAnuncio" class="form-label">
                                <i class="fas fa-calendar-alt text-primary me-1"></i>Fecha de Vencimiento
                            </label>
                            <input type="date" class="form-control" id="fechaVencimientoAnuncio" name="fechaVencimiento">
                            <div class="form-text">Opcional - Deja vacío para anuncio sin vencimiento</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-cog text-primary me-1"></i>Configuración
                            </label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="esImportante" name="esImportante">
                                <label class="form-check-label" for="esImportante">
                                    <i class="fas fa-star text-warning me-1"></i>Marcar como importante
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="activoAnuncio" name="activo" checked>
                                <label class="form-check-label" for="activoAnuncio">
                                    <i class="fas fa-eye text-success me-1"></i>Anuncio activo
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Vista previa del anuncio -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <i class="fas fa-eye text-primary me-1"></i>Vista Previa
                                </div>
                                <div class="card-body">
                                    <div id="previewAnuncio">
                                        <h6 id="previewTitulo" class="text-muted">Título aparecerá aquí...</h6>
                                        <p id="previewContenido" class="text-muted small">Contenido aparecerá aquí...</p>
                                        <div id="previewMetadata" class="d-flex justify-content-between text-muted small">
                                            <span id="previewTipo">Tipo: General</span>
                                            <span id="previewPrioridad">Prioridad: Normal</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Guardar Anuncio
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/views/admin/dashboard.js"></script>
}