async function crearNuevaFactura(tipoDocumento = 'Factura') {
    try {
        console.log('üÜï === CREANDO NUEVO DOCUMENTO ===');
        console.log('üÜï Tipo de documento:', tipoDocumento);
        console.log('üÜï Es conversi√≥n de proforma:', !!window.proformaOriginalParaConversion);

        // ‚úÖ NOTA: Esta funci√≥n maneja:
        // - Creaci√≥n de facturas normales
        // - Creaci√≥n de proformas 
        // - Conversi√≥n de proformas a facturas (marca autom√°ticamente la proforma como "Facturada")

        // Preparar datos de la venta con m√©todo de pago seleccionado
        const metodoPagoSeleccionado = esPagoMultiple ? 'multiple' : ($('input[name="metodoPago"]:checked').val() || 'efectivo');
        const configMetodo = esPagoMultiple ? CONFIGURACION_PRECIOS.efectivo : CONFIGURACION_PRECIOS[metodoPagoSeleccionado];

        // Validar pagos m√∫ltiples si es necesario
        if (esPagoMultiple && !validarPagosMultiples()) {
            return;
        }

        let subtotal = 0;

        // ‚úÖ CALCULAR SUBTOTAL DE PRODUCTOS
        productosEnVenta.forEach(producto => {
            const precioAjustado = producto.precioUnitario * configMetodo.multiplicador;
            subtotal += precioAjustado * producto.cantidad;
        });

        // ‚úÖ CALCULAR SUBTOTAL DE SERVICIOS
        if (window.serviciosEnVenta && window.serviciosEnVenta.length > 0) {
            window.serviciosEnVenta.forEach(servicio => {
                // Los servicios mantienen su precio base (no se ajustan por m√©todo de pago)
                const precioServicio = servicio.precioUnitario || servicio.precio || 0;
                subtotal += precioServicio * servicio.cantidad;
            });
        }

        const iva = subtotal * 0.13;
        const total = subtotal + iva;

        // ‚úÖ DETERMINAR ESTADO Y PERMISOS SEG√öN EL TIPO DE DOCUMENTO
        let estadoFactura, mensajeExito, debeImprimir, debeAjustarInventario;
        let fechaVencimiento = null;
        console.log('üîê === VERIFICACI√ìN DE PERMISOS ===');
        console.log('üîê puedeCompletarFacturas:', permisosUsuario.puedeCompletarFacturas);
        console.log('üîê puedeCrearFacturas:', permisosUsuario.puedeCrearFacturas);
        console.log('üîê tipoDocumento:', tipoDocumento);

        if (tipoDocumento === 'Proforma') {
            // ‚úÖ PROFORMAS: Siempre estado "Vigente" con fecha de vencimiento
            estadoFactura = 'Vigente';
            mensajeExito = 'Proforma creada exitosamente';
            debeImprimir = true;
            debeAjustarInventario = false; // Las proformas NO ajustan inventario

            // ‚úÖ CALCULAR FECHA DE VENCIMIENTO (30 d√≠as desde hoy)
            const fechaActual = new Date();
            fechaVencimiento = new Date(fechaActual.getTime() + (30 * 24 * 60 * 60 * 1000)); // +30 d√≠as
            console.log('üìã Creando proforma con estado VIGENTE');
            console.log('üìÖ Fecha de vencimiento calculada:', fechaVencimiento);
        } else if (permisosUsuario.puedeCompletarFacturas) {
            // ‚úÖ USUARIOS CON PERMISO COMPLETAR: Venta completa e inmediata
            estadoFactura = 'Pagada';
            mensajeExito = 'Venta procesada exitosamente y marcada como pagada';
            debeImprimir = true;
            debeAjustarInventario = true;
            console.log('üëë Procesando con permiso CompletarFacturas - Factura pagada inmediatamente con ajuste de stock');
        } else if (permisosUsuario.puedeCrearFacturas) {
            // ‚úÖ COLABORADORES: Factura pendiente para caja SIN AJUSTE DE STOCK
            estadoFactura = 'Pendiente';
            mensajeExito = 'Factura creada y enviada a Cajas para procesamiento de pago';
            debeImprimir = false;
            debeAjustarInventario = false; // ‚úÖ CRUCIAL: NO ajustar stock para colaboradores
            console.log('üìù Procesando como colaborador - Factura pendiente para caja SIN ajuste de stock');
        } else {
            // ‚ùå SIN PERMISOS: No deber√≠a llegar aqu√≠, pero como fallback
            throw new Error('No tienes permisos para procesar ventas');
        }

        console.log('üìã Estado determinado:', {
            tipoDocumento,
            estadoFactura,
            fechaVencimiento,
            debeImprimir,
            debeAjustarInventario,
            permisos: permisosUsuario
        });

        // Obtener informaci√≥n del usuario actual
        const usuarioActual = obtenerUsuarioActual();
        const usuarioId = usuarioActual?.usuarioId || usuarioActual?.id || 1;
        console.log('üë§ Usuario actual para documento:', {
            usuario: usuarioActual,
            usuarioId: usuarioId
        });

        // ‚úÖ CAPTURAR PRODUCTOS PENDIENTES DESDE LAS VARIABLES GLOBALES (solo para facturas)
        let productosPendientesParaEnvio = [];
        let tieneProductosPendientes = false;

        if (tipoDocumento === 'Factura' && window.productosPendientesEntrega && window.productosPendientesEntrega.length > 0) {
            console.log('üì¶ Productos pendientes detectados:', window.productosPendientesEntrega);
            productosPendientesParaEnvio = window.productosPendientesEntrega.map(producto => ({
                productoId: producto.productoId,
                nombreProducto: producto.nombreProducto || 'Sin nombre',
                cantidadSolicitada: producto.cantidadRequerida || producto.cantidadSolicitada || producto.cantidad || 0,
                cantidadPendiente: producto.cantidadPendiente || Math.max(0, (producto.cantidadRequerida || 0) - (producto.stockDisponible || 0)),
                stockDisponible: producto.stockDisponible || 0,
                precioUnitario: producto.precioUnitario || 0,
                observaciones: `Stock insuficiente al momento de la facturaci√≥n`
            }));
            tieneProductosPendientes = true;
        }

        // ‚úÖ CONSTRUIR OBSERVACIONES DIN√ÅMICAMENTE
        let observacionesFinal = $('#observacionesVenta').val() || '';

        // Si es conversi√≥n de proforma, agregar informaci√≥n en observaciones
        if (window.proformaOriginalParaConversion) {
            const numeroProforma = window.proformaOriginalParaConversion.numeroProforma;
            const textoProforma = `Convertido desde proforma ${numeroProforma}`;

            if (observacionesFinal && !observacionesFinal.includes(textoProforma)) {
                observacionesFinal = `${observacionesFinal}. ${textoProforma}`;
            } else if (!observacionesFinal) {
                observacionesFinal = textoProforma;
            }

            console.log('üìù Observaciones con informaci√≥n de proforma:', observacionesFinal);
        }

        // Crear objeto de factura para enviar a la API
        const facturaData = {
            clienteId: clienteSeleccionado?.clienteId || clienteSeleccionado?.id || null,
            nombreCliente: clienteSeleccionado?.nombre || 'Cliente General',
            identificacionCliente: clienteSeleccionado?.identificacion || '',
            telefonoCliente: clienteSeleccionado?.telefono || '',
            emailCliente: clienteSeleccionado?.email || '',
            direccionCliente: clienteSeleccionado?.direccion || '',
            fechaFactura: new Date().toISOString(),
            fechaVencimiento: fechaVencimiento ? fechaVencimiento.toISOString() : null,
            subtotal: subtotal,
            descuentoGeneral: 0,
            porcentajeImpuesto: 13,
            montoImpuesto: iva,
            total: total,
            estado: estadoFactura,
            tipoDocumento: tipoDocumento,
            metodoPago: metodoPagoSeleccionado,
            observaciones: observacionesFinal, // ‚úÖ USAR OBSERVACIONES CONSTRUIDAS DIN√ÅMICAMENTE
            usuarioCreadorId: usuarioId,

            // ‚úÖ INCLUIR PRODUCTOS PENDIENTES SI EXISTEN (solo para facturas)
            productosPendientesEntrega: productosPendientesParaEnvio,
            tieneProductosPendientes: tieneProductosPendientes,

            detallesPago: esPagoMultiple ? detallesPagoActuales.map(pago => ({
                metodoPago: pago.metodoPago,
                monto: pago.monto,
                referencia: pago.referencia || '',
                observaciones: pago.observaciones || '',
                fechaPago: new Date().toISOString()
            })) : [],

            detallesFactura: [
                // ‚úÖ PROCESAR PRODUCTOS
                ...productosEnVenta.map(producto => {
                    const precioAjustado = producto.precioUnitario * configMetodo.multiplicador;

                    // ‚úÖ CONSTRUIR NOMBRE COMPLETO CON MEDIDA SI ES LLANTA O TIPO SI ES SERVICIO
                    let nombreCompletoProducto = producto.nombreProducto;
                    if (producto.esServicio) {
                        nombreCompletoProducto = `[SERVICIO] ${producto.nombreProducto}`;
                        if (producto.observaciones) {
                            nombreCompletoProducto += ` - ${producto.observaciones}`;
                        }
                    } else if (producto.esLlanta && producto.medidaCompleta) {
                        nombreCompletoProducto = `${producto.medidaCompleta} ${producto.nombreProducto}`;
                    }

                    return {
                        productoId: producto.esServicio ? null : producto.productoId,
                        servicioId: producto.esServicio ? producto.servicioId : null,
                        nombreProducto: nombreCompletoProducto,
                        descripcionProducto: producto.descripcion || '',
                        cantidad: producto.cantidad,
                        precioUnitario: precioAjustado,
                        porcentajeDescuento: 0,
                        montoDescuento: 0,
                        subtotal: precioAjustado * producto.cantidad,
                        esServicio: producto.esServicio || false
                    };
                }),

                // ‚úÖ PROCESAR SERVICIOS
                ...(window.serviciosEnVenta || []).map(servicio => {
                    const precioServicio = servicio.precioUnitario || servicio.precio || 0;
                    let nombreCompletoServicio = `[SERVICIO] ${servicio.nombreProducto}`;

                    if (servicio.tipoServicio) {
                        nombreCompletoServicio += ` - ${servicio.tipoServicio}`;
                    }
                    if (servicio.observaciones) {
                        nombreCompletoServicio += ` - ${servicio.observaciones}`;
                    }

                    return {
                        productoId: null,
                        servicioId: servicio.servicioId,
                        nombreProducto: nombreCompletoServicio,
                        descripcionProducto: servicio.descripcion || '',
                        cantidad: servicio.cantidad,
                        precioUnitario: precioServicio,
                        porcentajeDescuento: 0,
                        montoDescuento: 0,
                        subtotal: precioServicio * servicio.cantidad,
                        esServicio: true
                    };
                })
            ]
        };

        console.log('üìã Datos de documento preparados:', facturaData);

        // Crear la factura/proforma
        const response = await fetch('/Facturacion/CrearFactura', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(facturaData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Error del servidor al crear documento:', errorText);
            throw new Error(`Error al crear el documento: ${response.status} - ${errorText}`);
        }

        const resultadoFactura = await response.json();
        console.log('‚úÖ Documento creado:', resultadoFactura);

        if (resultadoFactura.success) {
            // ‚úÖ MARCAR PROFORMA COMO FACTURADA SI ES UNA CONVERSI√ìN
            if (window.proformaOriginalParaConversion) {
                console.log('üîÑ === MARCANDO PROFORMA COMO FACTURADA ===');
                console.log('üîÑ Proforma original:', window.proformaOriginalParaConversion);

                // ‚úÖ VALIDAR QUE TENEMOS EL ID DE LA PROFORMA
                const proformaId = window.proformaOriginalParaConversion.proformaId || window.proformaOriginalParaConversion.facturaId;
                console.log('üîÑ ID de proforma a marcar:', proformaId);

                if (!proformaId) {
                    console.error('‚ùå No se pudo obtener el ID de la proforma para marcar como facturada');
                } else {
                    try {
                        const responseConversion = await fetch(`/Facturacion/MarcarProformaFacturada?proformaId=${proformaId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({})
                        });

                        const responseText = await responseConversion.text();
                        console.log('üîÑ Respuesta del servidor:', responseText);

                        if (responseConversion.ok) {
                            const resultadoConversion = JSON.parse(responseText);
                            console.log('‚úÖ Proforma marcada como facturada exitosamente:', resultadoConversion);
                        } else {
                            console.warn('‚ö†Ô∏è Error marcando proforma como facturada:', responseConversion.status, responseText);
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error en conversi√≥n de proforma, pero la factura se cre√≥:', error);
                    }
                }

                // Limpiar referencia
                delete window.proformaOriginalParaConversion;
            }

            // ‚úÖ REGISTRAR PRODUCTOS PENDIENTES SI EXISTEN (solo para facturas)
            if (tipoDocumento === 'Factura' && tieneProductosPendientes && productosPendientesParaEnvio.length > 0) {
                console.log('üì¶ === REGISTRANDO PRODUCTOS PENDIENTES DESPU√âS DE CREAR FACTURA ===');
                console.log('üì¶ Productos pendientes:', productosPendientesParaEnvio);
                console.log('üì¶ Factura creada ID:', resultadoFactura.facturaId || resultadoFactura.data?.facturaId);
                const facturaIdCreada = resultadoFactura.facturaId || resultadoFactura.data?.facturaId;
                if (facturaIdCreada) {
                    await registrarProductosPendientesEntrega(facturaIdCreada, productosPendientesParaEnvio);
                } else {
                    console.warn('‚ö†Ô∏è No se pudo obtener ID de factura para registrar pendientes');
                }
            }

            // ‚úÖ PROCESAR SEG√öN EL TIPO DE DOCUMENTO Y USUARIO
            if (tipoDocumento === 'Proforma') {
                // ‚úÖ PROFORMAS: Mostrar confirmaci√≥n y generar recibo
                console.log('üìã Proforma creada - Generando recibo');
                // ‚úÖ CERRAR MODAL DE FINALIZAR VENTA INMEDIATAMENTE
                modalFinalizarVenta.hide();
                // ‚úÖ GENERAR RECIBO PARA PROFORMA
                generarReciboFacturaCompletada(resultadoFactura, [...productosEnVenta, ...(window.serviciosEnVenta || [])], metodoPagoSeleccionado);
                // ‚úÖ MOSTRAR SWEETALERT DE CONFIRMACI√ìN
                Swal.fire({
                    icon: 'success',
                    title: '¬°Proforma Creada!',
                    html: `
                        <div class="text-center">
                            <p><strong>Proforma:</strong> ${resultadoFactura.numeroFactura || 'N/A'}</p>
                            <p><strong>V√°lida hasta:</strong> ${fechaVencimiento ? fechaVencimiento.toLocaleDateString('es-CR') : 'N/A'}</p>
                            <div class="alert alert-info mt-3">
                                <small><strong>Nota:</strong> Esta proforma tiene validez por 30 d√≠as calendario</small>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Continuar',
                    confirmButtonColor: '#28a745',
                    timer: 5000,
                    timerProgressBar: true
                });
            } else if (estadoFactura === 'Pendiente') {
                // ‚úÖ COLABORADORES: Modal espec√≠fico de env√≠o a cajas
                console.log('üìã Factura pendiente - Mostrando modal de env√≠o a cajas');
                // ‚úÖ CERRAR MODAL DE FINALIZAR VENTA INMEDIATAMENTE
                modalFinalizarVenta.hide();
                // ‚úÖ ACTUALIZAR VISTA DE PRODUCTOS (sin ajuste de stock)
                await actualizarVistaProductosPostAjuste();
                // Para colaboradores: mostrar modal espec√≠fico de env√≠o a cajas
                setTimeout(() => {
                    mostrarModalFacturaPendiente(resultadoFactura);
                }, 300);
            } else if (estadoFactura === 'Pagada') {
                // ‚úÖ ADMINISTRADORES/CAJEROS: Venta completa con ajuste de stock
                console.log('üí∞ Factura pagada - Procesando venta completa');
                // ‚úÖ AJUSTAR STOCK SOLO PARA FACTURAS PAGADAS
                if (debeAjustarInventario) {
                    console.log('üí∞ === INICIO AJUSTE INVENTARIO FRONTEND ===');
                    console.log('üí∞ Usuario autorizado - Ajustando inventario autom√°ticamente');
                    // ‚úÖ PROTECCI√ìN CONTRA DOBLE EJECUCI√ìN
                    const facturaNumero = resultadoFactura.numeroFactura || 'N/A';
                    const cacheKey = `stock_ajustado_${facturaNumero}`;
                    if (window[cacheKey]) {
                        console.log('‚ö†Ô∏è Stock ya fue ajustado para esta factura, saltando ajuste');
                    } else {
                        // Marcar como en proceso
                        window[cacheKey] = true;
                        try {
                            const productosParaAjuste = productosEnVenta.map(producto => ({
                                ProductoId: producto.productoId,
                                NombreProducto: producto.nombreProducto,
                                Cantidad: producto.cantidad
                            }));
                            const requestData = {
                                NumeroFactura: facturaNumero,
                                Productos: productosParaAjuste
                            };
                            console.log('üì¶ Ajustando stock para productos:', productosParaAjuste);
                            const responseStock = await fetch('/Facturacion/AjustarStockFacturacion', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify(requestData)
                            });
                            if (responseStock.ok) {
                                const resultadoStock = await responseStock.json();
                                console.log('‚úÖ Stock ajustado exitosamente');
                                // ‚úÖ ACTUALIZAR VISTA DE PRODUCTOS DESPU√âS DEL AJUSTE
                                await actualizarVistaProductosPostAjuste();
                            } else {
                                console.error('‚ùå Error ajustando stock');
                                console.warn('‚ùå Error ajustando stock - sin toast');
                            }
                        } catch (error) {
                            console.error('‚ùå Error general ajustando stock:', error);
                            console.warn('‚ùå Error inesperado ajustando inventario - sin toast');
                            delete window[cacheKey];
                        }
                    }
                    console.log('üí∞ === FIN AJUSTE INVENTARIO FRONTEND ===');
                }
                // ‚úÖ GENERAR E IMPRIMIR RECIBO PARA FACTURAS PAGADAS
                if (debeImprimir) {
                    console.log('üñ®Ô∏è Generando recibo para nueva factura pagada:', resultadoFactura);
                    // ‚úÖ USAR LA FUNCI√ìN ESPEC√çFICA PARA FACTURAS COMPLETADAS
                    generarReciboFacturaCompletada(resultadoFactura, [...productosEnVenta, ...(window.serviciosEnVenta || [])], metodoPagoSeleccionado);
                }
                // ‚úÖ CERRAR MODAL INMEDIATAMENTE DESPU√âS DE PROCESAR
                modalFinalizarVenta.hide();
                // ‚úÖ MOSTRAR SWEETALERT EN LUGAR DE TOAST
                Swal.fire({
                    icon: 'success',
                    title: '¬°Venta Completada!',
                    text: `Factura ${resultadoFactura.numeroFactura || 'N/A'} procesada exitosamente`,
                    confirmButtonText: 'Continuar',
                    confirmButtonColor: '#28a745',
                    timer: 3000,
                    timerProgressBar: true
                });
            }

            // ‚úÖ LIMPIAR CARRITO DESPU√âS DE PROCESAR (PARA TODOS LOS CASOS)
            productosEnVenta = [];

            // ‚úÖ LIMPIAR SERVICIOS TAMBI√âN
            if (window.serviciosEnVenta) {
                window.serviciosEnVenta = [];
            }

            clienteSeleccionado = null;
            $('#clienteBusqueda').val('');
            $('#clienteSeleccionado').addClass('d-none');
            actualizarVistaCarrito();
            actualizarTotales();
            actualizarEstadoBotonFinalizar();

            // ‚úÖ LIMPIAR VARIABLES DE PRODUCTOS PENDIENTES Y C√ìDIGOS DE SEGUIMIENTO
            if (window.productosPendientesEntrega) {
                delete window.productosPendientesEntrega;
            }
            if (window.facturaConPendientes) {
                delete window.facturaConPendientes;
            }

            // ‚úÖ LIMPIAR C√ìDIGOS DE SEGUIMIENTO DESPU√âS DE UN DELAY PARA QUE SE USEN EN EL RECIBO
            setTimeout(() => {
                if (window.codigosSeguimientoPendientes) {
                    console.log('üßπ Limpiando c√≥digos de seguimiento despu√©s del recibo');
                    delete window.codigosSeguimientoPendientes;
                }
            }, 3000); // 3 segundos de delay para que se use en el recibo

            // ‚úÖ ACTUALIZAR VISTA DE PRODUCTOS DESPU√âS DE COMPLETAR LA OPERACI√ìN
            setTimeout(async () => {
                try {
                    await actualizarVistaProductosPostAjuste();
                } catch (error) {
                    console.error('‚ùå Error actualizando vista despu√©s de operaci√≥n:', error);
                }
            }, 500);
        } else {
            // ‚úÖ MOSTRAR ERROR CON SWEETALERT
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error al procesar',
                    text: resultadoFactura.message || 'Error desconocido',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545'
                });
            } else {
                alert('Error: ' + (resultadoFactura.message || 'Error al procesar'));
            }
        }
    } catch (error) {
        console.error('‚ùå Error creando nuevo documento:', error);
        throw error;
    }
}
