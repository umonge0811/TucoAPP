/**
 * ‚úÖ FUNCI√ìN NUEVA: Obtener y verificar permisos espec√≠ficos del inventario
 */
async function cargarPermisosInventarioActual(inventarioId) {
    try {
        console.log('üîí === CARGANDO PERMISOS ESPEC√çFICOS DEL INVENTARIO ===');
        console.log('üîí Inventario ID:', inventarioId);

        const usuarioId = window.inventarioConfig?.usuarioId || ObtenerIdUsuarioActual();
        console.log('üîí Usuario ID:', usuarioId);

        // ‚úÖ VERIFICAR SI ES ADMINISTRADOR (SIEMPRE TIENE TODOS LOS PERMISOS)
        const esAdmin = await verificarEsAdministrador();

        if (esAdmin) {
            // ‚úÖ ADMIN TIENE TODOS LOS PERMISOS
            permisosInventarioActual = {
                puedeContar: true,
                puedeAjustar: true,
                puedeValidar: true,
                puedeCompletar: true,
                esAdmin: true,
                usuarioId: usuarioId
            };
            console.log('‚úÖ Usuario es administrador - Todos los permisos concedidos');
            return permisosInventarioActual;
        }

        // ‚úÖ OBTENER PERMISOS ESPEC√çFICOS DEL INVENTARIO
        const response = await fetch(`/TomaInventario/ObtenerPermisosUsuario/${inventarioId}/${usuarioId}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (response.ok) {
            const resultado = await response.json();

            if (resultado.success) {
                permisosInventarioActual = {
                    puedeContar: resultado.permisos.permisoConteo || false,
                    puedeAjustar: resultado.permisos.permisoAjuste || false,
                    puedeValidar: resultado.permisos.permisoValidacion || false,
                    puedeCompletar: resultado.permisos.permisoCompletar || false, // ‚Üê AGREGAR ESTA L√çNEA
                    esAdmin: false,
                    usuarioId: usuarioId
                };
                console.log('‚úÖ Permisos espec√≠ficos cargados:', permisosInventarioActual);
            } else {
                // Sin permisos espec√≠ficos
                permisosInventarioActual = {
                    puedeContar: false,
                    puedeAjustar: false,
                    puedeValidar: false,
                    esAdmin: false,
                    usuarioId: usuarioId
                };

                console.log('‚ö†Ô∏è Usuario sin permisos espec√≠ficos en este inventario');
            }
        } else {
            console.warn('‚ö†Ô∏è No se pudieron obtener permisos espec√≠ficos, usando configuraci√≥n global');

            // Fallback a configuraci√≥n global
            const configGlobal = window.inventarioConfig?.permisos || {};
            permisosInventarioActual = {
                puedeContar: configGlobal.puedeContar || false,
                puedeAjustar: configGlobal.puedeAjustar || false,
                puedeValidar: configGlobal.puedeValidar || false,
                puedeCompletar: configGlobal.puedeCompletar || false,
                esAdmin: configGlobal.esAdmin || false,
                usuarioId: usuarioId
            };
        }

        return permisosInventarioActual;

    } catch (error) {
        console.error('‚ùå Error cargando permisos del inventario:', error);

        // Permisos por defecto (sin acceso)
        permisosInventarioActual = {
            puedeContar: false,
            puedeAjustar: false,
            puedeValidar: false,
            esAdmin: false,
            usuarioId: ObtenerIdUsuarioActual()
        };

        return permisosInventarioActual;
    }
}
